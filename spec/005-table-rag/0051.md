# 数据表RAG

本项目旨在构建一个高效、可扩展的知识库管理系统。核心目标是允许用户通过上传结构化的Excel/CS文件，灵活定义知识库的
虚拟表结构（Schema），并将数据持久化至Elasticsearch以支持强大的全文检索和向量检索。
系统强调用户对检索方式的动态控制能力，并利用现代Rust技术栈确保高性能与高可靠性


## 业务逻辑
### 创建知识库流程
```mermaid
flowchart TD
    A[创建知识库] --> B(Step-1: 填写基础数据)
    B -->|校验知识库名称是否唯一,必填字段是否填写| C(Step-2: 选择数据)
    C -->|上传数据表| D[定义数据表名称, 上传文件, 提取文件列名, <br>用户定义数据表列类型及描述]
    C -->|远程数据表| E[填写远程数据库连接信息, 选择表]
    D --> F[Step-3: 索引设置]
    E --> H[后端进行数据库连接测试, 获取表列表]
    F --> G[点击保存]
    H --> G
    G --> I[存储知识库元数据]
    I --> |若选择的上传数据表| J[读取上传的文件数据]
    subgraph 创建异步任务
        J --> L[根据用户指定的检索列,数据向量化<br>存储到elasticsearch]
        L --> M[任务完成, 更新任务状态]
        M --> N[结束]
    end
```
> 每个文件创建一个异步任务

### 检索知识库数据流程
```mermaid
flowchart TD
    A[查询] -->|请求参数: dataset_id, dataset_type, query| B(判断dataset是上传数据表<br>还是远程数据表)
    B -->|上传数据表| C[获取数据表存储在OSS上的路径,<br>依据query变量-sql, <br>通过Elasticsearch库查询数据]
    B -->|远程数据表| E[获取数据库连接信息, <br>执行sql语句, 即query变量]
    C --> G[返回结果]
    E --> G
```

### 已存在的知识库,继续上传数据
> 此功能只对`上传数据表`(upload)类型知识库开放
```mermaid
flowchart TD
    A[选择知识库] -->|请求参数: dataset_id, dataset_type, query| B(判断知识库类型是否为`upload`)
    B -->|是| C[用户上传文件]
    C --> D[校验知识库schema是否与新上传文件的schema一致]
    D -->|一致|F[保存文件, 提取文件元数据, <br>存储到t_file表, 同时在t_dataset_file表<br>中添加映射, 解析新上传文件数据写到elasticsearch]
    D -->|不一致|H[提示用户schema不一致]
    B -->|否| E[不支持此功能]
    F --> G[结束]
    E --> G
    H --> G
```
> 流程中: 读取文件数据、向量化、数据存储到es由异步任务完成


### 后端技术栈
```shell
# 存储、读取阿里云OSS
cargo add opendal 

# 读取excel、csv数据
cargo add calamine 
cargo add csv 
```

阿里云bucket参数在配置文件中可配置(config/default.toml)


## 注意事项
* 前端页面组件使用shadcn组件
* 创建的后端数据表需可通过migrations自动升级
* 前端页面高度还原markdown中的图片
* 后端功能完成后需有单元测试